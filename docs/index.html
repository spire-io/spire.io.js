<!DOCTYPE html>  <html> <head>   <title>spire.io.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               spire.io.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>spire.io.js is a library designed to help you get your client-side web applications up and running with the high level services provided by the spire.io API. This plugin also exposes a methodology for directly interfacing with the spire.io REST interface.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>You can learn more about spire.io and it's services at http://spire.io, or find help with the following things:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <ul>
<li><a href="http://github.com/spire-io/spire.io.js">source code</a></li>
<li><a href="http://github.com/spire-io/spire.io.js/issues">issues</a></li>
<li><a href="http://spire.io/contact.html">contact spire.io</a></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">spire</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h1>XHRError</h1>

<p>XHRError is a wrapper for the xhr errors triggered by jQuery, this makes
it easier to pass an error to the callbacks of the async functions that
still retain their extra contextual information passed into the
<code>arguments</code> of <code>jQuery.ajax</code>'s <code>error</code> handler</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">XHRError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">message</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;XHRError&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">message</span> <span class="o">||</span> <span class="s1">&#39;XHRError&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">textStatus</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="o">?</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">||</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">jqueryErr</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">XHRError</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">();</span>
  <span class="nx">XHRError</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">XHRError</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h1>spire</h1>

<p>Set up the spire object with default <code>options</code> for <code>url</code>, <code>version</code>,
and <code>timeout</code> as well as stub out some objects to make method definitions
obvious.</p>

<ul>
<li><strong>spire.options.url</strong>: The url of the spire.io API, defaults to
<a href="http://api.spire.io">http://api.spire.io</a>.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">spire</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">options</span><span class="o">:</span> <span class="p">{</span> <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://api.spire.io&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <ul>
<li><strong>spire.options.version</strong>: The spire.io API version to use when making requests for resources, defaults to 1.0.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">version</span><span class="o">:</span> <span class="s1">&#39;1.0&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <ul>
<li><strong>spire.options.timeout</strong>: The timeout for long-polling in seconds, defaults to 30 seconds</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">timeout</span><span class="o">:</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">30</span>
    <span class="p">}</span>
  <span class="p">,</span> <span class="nx">cache</span><span class="o">:</span> <span class="p">{}</span>
  <span class="p">,</span> <span class="nx">isConnecting</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{}</span>
  <span class="p">,</span> <span class="nx">messages</span><span class="o">:</span> <span class="p">{</span> <span class="nx">queue</span><span class="o">:</span> <span class="p">[]</span> <span class="p">}</span>
  <span class="p">,</span> <span class="nx">accounts</span><span class="o">:</span> <span class="p">{}</span>
  <span class="p">,</span> <span class="nx">account</span><span class="o">:</span> <span class="p">{}</span>
  <span class="p">,</span> <span class="nx">requests</span><span class="o">:</span> <span class="p">{</span> <span class="nx">description</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">,</span> <span class="nx">sessions</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">,</span> <span class="nx">channels</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">,</span> <span class="nx">subscriptions</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">,</span> <span class="nx">messages</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">,</span> <span class="nx">accounts</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">,</span> <span class="nx">billing</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">reqwest</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span> <span class="o">=</span> <span class="nx">reqwest</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">module</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">require</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>This builds an ajax-like inteface around request.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">params</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">headers</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="nx">params</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Gotta munge the data ourselves.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;put&#39;</span> <span class="o">||</span> <span class="nx">params</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;post&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">params</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">params</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">first</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">params</span><span class="p">.</span><span class="nx">url</span> <span class="o">+=</span> <span class="nx">first</span> <span class="o">?</span> <span class="s1">&#39;?&#39;</span> <span class="o">:</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">;</span>
            <span class="nx">params</span><span class="p">.</span><span class="nx">url</span> <span class="o">+=</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
            <span class="nx">first</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">params</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">params</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;json&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">params</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
      <span class="p">};</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;json&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Accept&#39;</span><span class="p">])</span> <span class="p">{</span>
          <span class="nx">params</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Accept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;application/json&quot;</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">request</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">handler</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="s2">&quot;The Spire.JS library requires reqwest: https://github.com/ded/reqwest to run in a browser.&quot;</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h1>spire.headers</h1>

<p>Helpers for generating header values for the http requests to the
spire.io API.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>spire.headers.authorization</h2>

<p>Generate the authorization header for a resource with a capability.
Requires a resource object with a <code>capability</code> key.</p>

<pre><code>authorization = spire.headers.authorization(subscription);
//=&gt; 'Capability 5iyTrZrcGw/X4LxhXJRIEn4HwFKSFB+iulVKkUjqxFq30cFBqEm'
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resource</span><span class="p">){</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Capability&#39;</span><span class="p">,</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">capability</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>spire.headers.mediaType</h2>

<p>Generate either a 'content-type' or 'authorization' header, requires a
string with the name of the resource so it can extract the media type
from the API's schema.</p>

<pre><code>spire.headers.mediaType('channel');
//=&gt; 'application/vnd.spire-io.channel+json;version=1.0'
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resourceName</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">schema</span><span class="p">[</span><span class="nx">spire</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">version</span><span class="p">][</span><span class="nx">resourceName</span><span class="p">].</span><span class="nx">mediaType</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h1>spire.messages</h1>

<p>Provides a high level interface for message publishing and subscribing.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h2>spire.messages.subscribe</h2>

<p>Subscribe to a channel with the <code>name</code>, when new messages come in trigger
the <code>callback</code> every time. This method uses long-polling to get the
events from a subscription resource and wraps up all the complexities of
interfacing with the REST API (discovery, session creation, channel
creation, subscription creation, and event listening for the
subscription).</p>

<p>The callback is triggered with two arguments, an <code>error</code> object and a
<code>messages</code> array</p>

<pre><code>spire.messages.subscribe('chat example', function(err, messages){
  $.each(messages, function(i, message){
    var el = $('&lt;div class="message"&gt;').text(message);

    $('.messages').append(el);
  });
});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">spire</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">subscribe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">session</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">session</span><span class="o">:</span> <span class="nx">session</span>
          <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span>
          <span class="p">}</span>
      <span class="p">;</span>

      <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">channel</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">409</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">session</span><span class="p">){</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

              <span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="nx">session</span>
                  <span class="p">.</span><span class="nx">resources</span>
                  <span class="p">.</span><span class="nx">channels</span>
                  <span class="p">.</span><span class="nx">resources</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
              <span class="p">;</span>

              <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">channel</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">channels</span><span class="o">:</span> <span class="p">[</span> <span class="nx">channel</span> <span class="p">]</span>
                    <span class="p">,</span> <span class="nx">events</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;messages&#39;</span> <span class="p">]</span>
                    <span class="p">,</span> <span class="nx">session</span><span class="o">:</span> <span class="nx">session</span>
                    <span class="p">}</span>
                <span class="p">;</span>


                <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sub</span><span class="p">){</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

                  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">subscription</span><span class="o">:</span> <span class="nx">sub</span> <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Get events from the subscription</p>             </td>             <td class="code">               <div class="highlight"><pre>                  <span class="kd">var</span> <span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
                    <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">events</span><span class="p">){</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

                      <span class="k">if</span> <span class="p">(</span><span class="nx">events</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
                        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">messages</span><span class="p">);</span>
                      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Do it all over again</p>             </td>             <td class="code">               <div class="highlight"><pre>                      <span class="nx">get</span><span class="p">();</span>
                    <span class="p">});</span>
                  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Kick off long-polling</p>             </td>             <td class="code">               <div class="highlight"><pre>                  <span class="nx">get</span><span class="p">();</span>
                <span class="p">});</span>

              <span class="p">});</span>
            <span class="p">});</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">channels</span><span class="o">:</span> <span class="p">[</span> <span class="nx">channel</span> <span class="p">]</span>
            <span class="p">,</span> <span class="nx">events</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;messages&#39;</span> <span class="p">]</span>
            <span class="p">,</span> <span class="nx">session</span><span class="o">:</span> <span class="nx">session</span>
            <span class="p">}</span>
        <span class="p">;</span>


        <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sub</span><span class="p">){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">subscription</span><span class="o">:</span> <span class="nx">sub</span> <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Get events from the subscription</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">events</span><span class="p">){</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

              <span class="k">if</span> <span class="p">(</span><span class="nx">events</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
                <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">messages</span><span class="p">);</span>
              <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Do it all over again</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nx">get</span><span class="p">();</span>
            <span class="p">});</span>
          <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Kick off long-polling</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">get</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h2>spire.messages.publish</h2>

<p>Publish a message. This method takes the <code>options</code> <code>channel</code>,
which is the name of the channel to publish the message to and <code>content</code>
which is the content of the message you want to publish. It can also take
an optional callback which gets called with an <code>error</code> and a <code>message</code>
object.</p>

<pre><code>  // Fire and forget
  var options = { channel: 'chat example', content: 'herow' };

  spire.messages.publish(options);
</code></pre>

<p>Or:</p>

<pre><code>  // Do something specific to sending this message
  spire.messages.publish(options, function(err, message){
     // you should probably do something useful though
    if (err) throw err;

    $('form').hide();
  });
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">spire</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">publish</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>If the <code>spire</code> is busy connecting, queue the message and return.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">spire</span><span class="p">.</span><span class="nx">isConnecting</span><span class="p">){</span>
      <span class="nx">spire</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span>
      <span class="p">,</span> <span class="nx">callback</span><span class="o">:</span> <span class="nx">callback</span>
      <span class="p">});</span>

      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Connect; discover and create a session.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">spire</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">session</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">session</span><span class="o">:</span> <span class="nx">session</span>
          <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">channel</span>
          <span class="p">}</span>
      <span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Create the channel before sending a message to it.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">channel</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">session</span><span class="o">:</span> <span class="nx">session</span>
            <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">channel</span>
            <span class="p">}</span>
        <span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">409</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">session</span><span class="p">){</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
                <span class="k">else</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
              <span class="p">}</span>

              <span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="nx">session</span>
                  <span class="p">.</span><span class="nx">resources</span>
                  <span class="p">.</span><span class="nx">channels</span>
                  <span class="p">.</span><span class="nx">resources</span><span class="p">[</span><span class="nx">message</span><span class="p">.</span><span class="nx">channel</span><span class="p">]</span>
              <span class="p">;</span>

              <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">channel</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">channel</span><span class="o">:</span> <span class="nx">channel</span>
                    <span class="p">,</span> <span class="nx">content</span><span class="o">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">content</span>
                    <span class="p">}</span>
                <span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Finally send the message.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">message</span><span class="p">){</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

                  <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
                <span class="p">});</span>
              <span class="p">})</span>
            <span class="p">});</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
          <span class="p">}</span>

          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">channel</span><span class="o">:</span> <span class="nx">channel</span>
            <span class="p">,</span> <span class="nx">content</span><span class="o">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">content</span>
            <span class="p">}</span>
        <span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Finally send the message.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">message</span><span class="p">){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h1>spire.accounts</h1>

<p>Provides a high level interface for accounts. This is what the spire.io
website uses for logging in, registration, and account updates.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h2>spire.accounts.create</h2>

<p>Wrapper for creating an account, makes a call for the API description
then creates the account. It requires an account object (with at least an
<code>email</code> and a <code>password</code>) and a <code>callback</code>. The <code>callback</code> will be called
with the arguments: <code>error</code> and <code>session</code>. The <code>session</code> is a session
resource.</p>

<pre><code>var account = { email: 'jxson@jxson.cc'
    , password: 'topsecret'
    }
;

spire.accounts.create(account, function(err, session){
  // seriously, do something useful with this error...
  if (err) throw err;

  console.log(session);
});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">spire</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">account</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">description</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

      <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">account</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h2>spire.accounts.update</h2>

<p>Wrapper for updating an account, it requires an authenticated <code>account</code>
resource and a <code>callback</code>. The callback will be triggered with the
arguments: an <code>error</code> object and an <code>account</code> resource object.</p>

<pre><code>account.email = 'something-else@test.com';

spire.accounts.update(account, function(err, account){
  if (err) throw err;

  console.log(account);
});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">spire</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">account</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">description</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

      <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">account</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h2>spire.accounts.authenticate</h2>

<p>Creates a session for a given account, expects an <code>account</code> object with
<code>password</code> and <code>email</code> properties and a <code>callback</code>. The callback gets
called with the arguments <code>error</code>, <code>session</code></p>

<pre><code>var account = { email: 'jxson@jxson.cc'
    , password: 'totally-secure'
    }
;

spire.accounts.authenticate(account, function(err, session){
  if (err) return callback(err);

  console.log(session);
});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">spire</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">authenticate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">account</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">description</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">key</span>
          <span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="nx">account</span><span class="p">.</span><span class="nx">email</span>
          <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">account</span><span class="p">.</span><span class="nx">password</span>
          <span class="p">}</span>
      <span class="p">;</span>

      <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h1>spire.connect</h1>

<p>provides a single point of connection that builds up the needed objects
for discovery and sharing a session between requests.
the callback is triggered with an error and a session</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">spire</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">){</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">isConnecting</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">description</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">key</span> <span class="p">};</span>

      <span class="kd">var</span> <span class="nx">sessionBack</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">session</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

        <span class="nx">spire</span><span class="p">.</span><span class="nx">isConnecting</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>save it for later.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">spire</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="nx">session</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>publish any messages in the queue</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">spire</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">args</span><span class="p">;</span>
          <span class="k">while</span> <span class="p">(</span><span class="nx">args</span> <span class="o">=</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">pop</span><span class="p">())</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>try it again, its possible this loop might get fired in
parallel effecting the queue so make sure that the args are
defined before calling the publish function</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">session</span><span class="p">);</span>
      <span class="p">};</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">spire</span><span class="p">.</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sessionBack</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">session</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">sessionBack</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h1>spire.requests</h1>

<p>Requests are raw and assume nothing besides the spire.io API url set in
<code>spire.options.url</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <h2>spire.requests.description.get</h2>

<p>Gets the description resource object and caches it for later, the
<code>callback</code> is triggered with an <code>error</code> object and the <code>description</code>
resource object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>If discovery has already happened use the cache.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">spire</span><span class="p">.</span><span class="nx">resources</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">description</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">resources</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">resources</span>
          <span class="p">,</span> <span class="nx">schema</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">schema</span>
          <span class="p">}</span>
      <span class="p">;</span>

      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">description</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>If there isn't a cache make an XHR to get the description.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span>
      <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span>
      <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XHRError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <h3>UGH.</h3>

<p>XHR handlers always get executed on the <code>window</code>, I tried to
write a nice wrapper to help with testing but all it's methods
were getting called with <code>this</code> bound to the window.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">description</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">spire</span><span class="p">.</span><span class="nx">resources</span> <span class="o">=</span> <span class="nx">description</span><span class="p">.</span><span class="nx">resources</span><span class="p">;</span>
          <span class="nx">spire</span><span class="p">.</span><span class="nx">schema</span> <span class="o">=</span> <span class="nx">description</span><span class="p">.</span><span class="nx">schema</span><span class="p">;</span>

          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">description</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;get&#39;</span>
      <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">session</span><span class="p">.</span><span class="nx">url</span>
      <span class="p">,</span> <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">){</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">(</span><span class="nx">session</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XHRError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">session</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

  <span class="p">};</span>

  <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">options</span><span class="p">.</span><span class="nx">key</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">email</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">password</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)){</span>
      <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;You need a key to do that! Try doing this:&#39;</span>
          <span class="p">,</span> <span class="s1">&#39;   spire.options.key = &lt;your account key&gt;&#39;</span>
          <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
      <span class="p">;</span>

      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">email</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span>
      <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">url</span>
      <span class="p">,</span> <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">){</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XHRError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">session</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;get&#39;</span>
      <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">url</span>
      <span class="p">,</span> <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">xhr</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;channel&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XHRError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">channel</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">channels</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">channels</span>
      <span class="p">,</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">;</span>

    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span>
      <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">channels</span><span class="p">.</span><span class="nx">url</span>
      <span class="p">,</span> <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">xhr</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;channel&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;channel&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">(</span><span class="nx">channels</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span> <span class="p">})</span>
      <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XHRError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">channel</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="cm">/*</span>

<span class="cm">  {</span>
<span class="cm">    channels: [ channel ],</span>
<span class="cm">    events: [ &#39;messages&#39; ],</span>
<span class="cm">    session: sessionObj</span>
<span class="cm">  }</span>

<span class="cm">  */</span>
  <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">subscriptions</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">subscriptions</span>
      <span class="p">,</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">events</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">events</span>
        <span class="p">,</span> <span class="nx">channels</span><span class="o">:</span> <span class="p">[]</span>
        <span class="p">}</span>
    <span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p><strong>!</strong> The subscription create request wants an array of channel urls
not 'channel' resource objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">url</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span>
      <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">subscriptions</span><span class="p">.</span><span class="nx">url</span>
      <span class="p">,</span> <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">){</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;subscription&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;subscription&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">(</span><span class="nx">subscriptions</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XHRError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subscription</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">subscription</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="cm">/*</span>

<span class="cm">  {</span>
<span class="cm">    timeout: ...,</span>
<span class="cm">    subscription: subscription</span>
<span class="cm">  }</span>

<span class="cm">  */</span>
  <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">subscription</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">subscription</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">timeout</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">||</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">timeout</span><span class="o">/</span><span class="mi">1000</span> <span class="p">}</span>
    <span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">subscription</span><span class="p">[</span><span class="s1">&#39;last-message&#39;</span><span class="p">])</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">[</span><span class="s1">&#39;last-message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">subscription</span><span class="p">[</span><span class="s1">&#39;last-message&#39;</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;get&#39;</span>
      <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">subscription</span><span class="p">.</span><span class="nx">url</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>, timeout: options.timeout + 10000</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">,</span> <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">){</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">(</span><span class="nx">subscription</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span>
      <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>fake a returned events object</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">errorThrown</span> <span class="o">===</span> <span class="s1">&#39;timeout&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nx">messages</span><span class="o">:</span> <span class="p">[]</span> <span class="p">});</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XHRError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">);</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>set the last message key if there are messages</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">messageCount</span> <span class="o">=</span> <span class="nx">events</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">messageCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nx">subscription</span><span class="p">[</span><span class="s1">&#39;last-message&#39;</span><span class="p">]</span> <span class="o">=</span>
              <span class="nx">events</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="nx">messageCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">timestamp</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">events</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>{ channel: {}, content: .. }</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">channel</span>
      <span class="p">,</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">content</span>
    <span class="p">;</span>

    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span>
      <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">url</span>
      <span class="p">,</span> <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">){</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">content</span><span class="o">:</span> <span class="nx">content</span> <span class="p">})</span>
      <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XHRError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">account</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span>
      <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">url</span>
      <span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
      <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">session</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XHRError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">account</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;put&#39;</span>
      <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">account</span><span class="p">.</span><span class="nx">url</span>
      <span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
      <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">account</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">account</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XHRError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">account</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span>
      <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">account</span><span class="p">.</span><span class="nx">url</span>
      <span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
      <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">account</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">account</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XHRError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">spire</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">billing</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">){</span>
    <span class="nx">spire</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span>
      <span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">billing</span><span class="p">.</span><span class="nx">url</span>
      <span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;billing&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="nx">spire</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">(</span><span class="s1">&#39;billing&#39;</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span>
      <span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XHRError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">);</span>

          <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">billing</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">){</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">billing</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">spire</span><span class="p">;</span>
<span class="p">})();</span>

<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">module</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">spire</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 