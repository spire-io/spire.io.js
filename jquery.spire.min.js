(function(a){var b=function(a,b,c,d){this.name="XHRError",this.message=d||"XHRError",this.xhr=a,this.status=b,this.jqueryErr=c};b.prototype=new Error,b.prototype.constructor=b,a.spire={options:{url:"http://api.spire.io",version:"1.0",timeout:3e4},cache:{},isConnecting:!1,headers:{},messages:{queue:[]},accounts:{},account:{},requests:{description:{},sessions:{},channels:{},subscriptions:{},messages:{},accounts:{},billing:{}}},a.spire.headers.authorization=function(a){return["Capability",a.capability].join(" ")},a.spire.headers.mediaType=function(b){return a.spire.schema[a.spire.options.version][b].mediaType},a.spire.messages.subscribe=function(b,c){a.spire.connect(function(d,e){if(d)return c(d);var f={session:e,name:b};a.spire.requests.channels.create(f,function(b,d){if(b)return c(b);var f={channels:[d],events:["messages"],session:e};a.spire.requests.subscriptions.create(f,function(b,d){if(b)return c(b);var e={subscription:d},f=function(){a.spire.requests.subscriptions.get(e,function(a,b){if(a)return c(a);b.messages.length>0&&c(null,b.messages),f()})};f()})})})},a.spire.messages.publish=function(b,c){if(a.spire.isConnecting){a.spire.messages.queue.push({message:b,callback:c});return}a.spire.connect(function(d,e){if(d)return c(d);var f={session:e,name:b.channel};a.spire.requests.channels.create(f,function(d,e){if(d)return c(d);var f={channel:e,content:b.content};a.spire.requests.messages.create(f,function(a,b){if(a)return c(a);c&&c(null,b)})})})},a.spire.accounts.create=function(b,c){a.spire.requests.description.get(function(d,e){if(d)return c(d);a.spire.requests.accounts.create(b,c)})},a.spire.accounts.update=function(b,c){a.spire.requests.description.get(function(d,e){if(d)return c(d);a.spire.requests.accounts.update(b,c)})},a.spire.accounts.authenticate=function(b,c){a.spire.requests.description.get(function(d,e){if(d)return c(d);var f={key:a.spire.options.key,email:b.email,password:b.password};a.spire.requests.sessions.create(f,c)})},a.spire.connect=function(b){a.spire.isConnecting=!0,a.spire.requests.description.get(function(c,d){if(c)return b(c);var e={key:a.spire.options.key},f=function(c,d){return c?b(c):(a.spire.isConnecting=!1,a.spire.session=d,a.spire.messages.queue.length>0&&a.each(a.spire.messages.queue,function(b){var c=a.spire.messages.queue.pop();c&&a.spire.messages.publish(c.message,c.callback)}),b(null,d))};a.spire.session?f(null,a.spire.session):a.spire.requests.sessions.create(e,f)})},a.spire.requests.description.get=function(c){if(a.spire.resources){var d={resources:a.spire.resources,schema:a.spire.schema};return c(null,d)}a.ajax({type:"GET",url:a.spire.options.url,dataType:"json",error:function(a,d,e){var f=new b(arguments);c(f)},success:function(b,d,e){a.spire.resources=b.resources,a.spire.schema=b.schema,c(null,b)}})},a.spire.requests.sessions.create=function(c,d){if(!c.key&&(!c.email||!c.password)){var e=["You need a key to do that! Try doing this:","   $.spire.options.key = <your account key>"].join("\n");throw new Error(e)}c.email&&c.password&&(c.key=null),a.ajax({type:"post",url:a.spire.resources.sessions.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":a.spire.headers.mediaType("account"),Accept:a.spire.headers.mediaType("session")},data:JSON.stringify(c),dataType:"json",error:function(a){var c=new b(arguments);d(c)},success:function(a,b,c){d(null,a)}})},a.spire.requests.channels.create=function(c,d){var e=c.session.resources.channels,f=c.name;a.ajax({type:"post",url:e.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":a.spire.headers.mediaType("channel"),Accept:a.spire.headers.mediaType("channel"),Authorization:a.spire.headers.authorization(e)},data:JSON.stringify({name:f}),dataType:"json",error:function(a){var c=new b(arguments);d(c)},success:function(a,b,c){d(null,a)}})},a.spire.requests.subscriptions.create=function(c,d){var e=c.session.resources.subscriptions,f={events:c.events,channels:[]};a.each(c.channels,function(a,b){f.channels.push(b.url)}),a.ajax({type:"post",url:e.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":a.spire.headers.mediaType("subscription"),Accept:a.spire.headers.mediaType("subscription"),Authorization:a.spire.headers.authorization(e)},data:JSON.stringify(f),dataType:"json",error:function(a){var c=new b(arguments);d(c)},success:function(a,b,c){d(null,a)}})},a.spire.requests.subscriptions.get=function(c,d){var e=c.subscription;data={timeout:c.timeout||a.spire.options.timeout/1e3},data["last-message"]=e["last-message"],a.ajax({type:"get",url:e.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":a.spire.headers.mediaType("events"),Accept:a.spire.headers.mediaType("events"),Authorization:a.spire.headers.authorization(e)},data:data,dataType:"json",error:function(a,c,e){if(e==="timeout")d(null,{messages:[]});else{var f=new b(arguments);d(f)}},success:function(b,c,f){b.messages.length>0&&(e["last-message"]=a(b.messages).last()[0].timestamp),d(null,b)}})},a.spire.requests.messages.create=function(c,d){var e=c.channel,f=c.content;a.ajax({type:"post",url:e.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":a.spire.headers.mediaType("message"),Accept:a.spire.headers.mediaType("message"),Authorization:a.spire.headers.authorization(e)},data:JSON.stringify({content:f}),dataType:"json",error:function(a){var c=new b(arguments);d(c)},success:function(a,b,c){d(null,a)}})},a.spire.requests.accounts.create=function(c,d){a.ajax({type:"post",url:a.spire.resources.accounts.url,headers:{"Content-Type":a.spire.headers.mediaType("account"),Accept:a.spire.headers.mediaType("session")},data:JSON.stringify(c),success:function(a,b,c){d(null,a)},error:function(a,c,e){var f=new b(arguments);d(f)}})},a.spire.requests.accounts.update=function(c,d){a.ajax({type:"put",url:c.url,headers:{"Content-Type":a.spire.headers.mediaType("account"),Accept:a.spire.headers.mediaType("account"),Authorization:a.spire.headers.authorization(c)},data:JSON.stringify(c),dataType:"json",success:function(a,b,c){d(null,a)},error:function(a,c,e){var f=new b(arguments);d(f)}})},a.spire.requests.accounts.reset=function(c,d){a.ajax({type:"post",url:c.url,headers:{"Content-Type":a.spire.headers.mediaType("account"),Accept:a.spire.headers.mediaType("account"),Authorization:a.spire.headers.authorization(c)},dataType:"json",success:function(a,b,c){d(null,a)},error:function(a,c,e){var f=new b(arguments);d(f)}})},a.spire.requests.billing.get=function(c){a.ajax({type:"GET",url:a.spire.resources.billing.url,headers:{"Content-Type":a.spire.headers.mediaType("billing"),Accept:a.spire.headers.mediaType("billing")},dataType:"json",error:function(a,d,e){var f=new b(arguments);c(f)},success:function(a,b,d){c(null,a)}})}})(jQuery)